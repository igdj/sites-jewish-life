{% extends 'AppBundle:Default:base.html.twig' %}
{% block head %}
    <link rel="stylesheet" href="{{ app.request.basepath }}/vendor/leaflet-0.7.7/leaflet.css" />
    <script src="{{ app.request.basepath }}/vendor/leaflet-0.7.7/leaflet.js"></script>

    <link rel="stylesheet" href="{{ app.request.basepath }}/vendor/leaflet.label/leaflet.label.css" />
    <script src="{{ app.request.basepath }}/vendor/leaflet.label/leaflet.label.js"></script>
    <style>
    .my-label {
        color: white;
        position: absolute;
        z-index: -1;
        background: none;
        border: none;
    }

    .my-label:before,
    .my-label:after {
        border: none;
    }
    </style>
{% endblock %}

{% block body %}
    <div class="row">
        <div id="map" class="col-sm-12" style="min-height: 360px">
        <script>
            function adjustMapHeight() {
                $('#map').height(function(index, height) {
                    return window.innerHeight - $(this).offset().top;
                });
            }

            $( window ).resize(adjustMapHeight);
            adjustMapHeight();

            var map = L.map('map');

            // map.setView([ 53.56810009, 9.9862097 ], 13);
            map.fitBounds([ [ 53.58769, 9.99599  ],
                            [ 53.5600881, 9.9688 ] ]);




            if (true) {
                L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiaGF1c3ZlcnN0YW5kIiwiYSI6ImNpemU2OWJvaTAwNHIyd252b2ptaDV2NjkifQ.FGA8-opghZHquZJKlHSFdg', {
                    maxZoom: 16,
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                        'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                    id: 'mapbox.streets'
                }).addTo(map);
            }
            else {
                L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
                    id: 'mapbox.streets'
                }).addTo(map);
            }

            var hash = window.location.hash.substring(1);

            var markerProperties = {
                radius: 12,
                fillColor: '#d42132',
                color: '#d42132',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8,
            };

            {% for site in sites %}
            {# markerProperties['title'] = {{ site.title['de']|json_encode|raw }}; #}
            var marker = L.circleMarker([ {{ site.latitude }}, {{ site.longitude }} ],
                                        markerProperties)
                .bindLabel('{{ site.getMarker() }}', { noHide: true, offset: [-9,-11], className: "my-label" })
                .addTo(map)
                .bindPopup({{ site.popup|json_encode|raw }})
                ;

            if ('{{ site.id }}' == hash) {
                marker.openPopup();
            }
            {% endfor %}
            </script>
        </div>
    </div>
{% endblock %}
